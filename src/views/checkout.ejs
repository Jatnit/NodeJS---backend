<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moda Studio | Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .checkout-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 992px) {
            .checkout-layout {
                grid-template-columns: 3fr 2fr;
            }

            .summary-column {
                position: sticky;
                top: 100px;
                height: fit-content;
            }
        }

        .floating-label label {
            font-size: 0.85rem;
            color: var(--muted-text);
        }

        .floating-label input,
        .floating-label textarea {
            border-radius: 12px;
            border: 1px solid var(--border-color, #ccc);
        }

        .payment-card {
            border: 1px solid var(--border-color, #ccc);
            border-radius: 16px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-card.selected {
            border-color: #111;
            background-color: #111;
            color: #fff;
        }

        .summary-card {
            border-radius: 20px;
            border: 1px solid var(--border-color, #ddd);
            padding: 1.5rem;
            background: var(--card-bg, #fff);
            box-shadow: 0 25px 40px rgba(0, 0, 0, 0.08);
        }

        .qr-card {
            border: 1px dashed var(--border-color, #ccc);
            border-radius: 20px;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.02);
        }

        body.theme-dark .qr-card {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .qr-card img {
            max-width: 260px;
            border-radius: 16px;
        }
    </style>
</head>

<body class="<%= theme === 'dark' ? 'theme-dark' : 'theme-light' %>">
    <%- include('partials/header') %>

        <main class="site-main">
            <div class="container py-5">
                <% if (errorMessage) { %>
                    <div class="alert alert-danger text-center">
                        <%= errorMessage %>
                    </div>
                    <% } %>
                        <div id="checkoutFeedback"></div>

                        <% if (!cart || !cart.items || !cart.items.length) { %>
                            <p class="text-center text-muted">Giỏ hàng trống. <a href="/products">Tiếp tục mua sắm</a>
                            </p>
                            <% } else { const shippingData=(shippingPrefill && typeof shippingPrefill==='object' ) ?
                                shippingPrefill : { name: '' , phone: '' , address: '' , note: '' }; const
                                selectedPayment=paymentPrefill || 'COD' ; const hasSavedAddresses=addresses &&
                                addresses.length> 0;
                                const qrConfig = qrPaymentConfig || {};
                                %>
                                <form action="/checkout" method="POST" class="checkout-layout" id="checkoutForm">
                                    <section>
                                        <h3 class="mb-4 text-uppercase" style="letter-spacing: 0.2em;">Thông tin giao
                                            hàng</h3>

                                        <% if (hasSavedAddresses) { %>
                                            <% const hasDefaultAddress=(addresses || []).some(function(addr){ return
                                                addr.isDefault; }); %>
                                                <div class="mb-4">
                                                    <label class="form-label text-muted">Chọn địa chỉ đã lưu</label>
                                                    <div class="list-group">
                                                        <% addresses.forEach(function(address, index){ const
                                                            shouldCheck=address.isDefault || (!hasDefaultAddress &&
                                                            index===0); %>
                                                            <label class="list-group-item list-group-item-action">
                                                                <input type="radio" name="addressId"
                                                                    value="<%= address.id %>"
                                                                    class="form-check-input me-2"
                                                                    data-name="<%= address.recipientName || '' %>"
                                                                    data-phone="<%= address.phoneNumber || '' %>"
                                                                    data-address="<%= [address.addressLine, address.ward, address.district, address.city].filter(Boolean).join(', ') %>"
                                                                    <%=shouldCheck ? "checked" : "" %>>
                                                                <div>
                                                                    <strong>
                                                                        <%= address.recipientName %>
                                                                    </strong>
                                                                    <p class="mb-0">
                                                                        <%= address.phoneNumber %>
                                                                    </p>
                                                                    <p class="mb-0">
                                                                        <%= [address.addressLine, address.ward,
                                                                            address.district,
                                                                            address.city].filter(Boolean).join(', ') %></p>
                                                </div>
                                            </label>
                                        <% }) %>
                                    </div>
                                </div>
                            <% } else { %>
                                <div class="alert alert-warning border-0 bg-warning-subtle text-dark">
                                    Bạn chưa có địa chỉ nhận hàng đã lưu. Vui lòng nhập thông tin vào biểu mẫu bên dưới để tiếp tục.
                                </div>
                            <% } %>

                            <div class="row g-3 mb-3 floating-label">
                                <div class="col-md-6">
                                    <label for="shippingName" class="form-label">Tên người nhận</label>
                                    <input type="text" class="form-control" id="shippingName" name="shippingName"
                                        value="<%= shippingData.name || '' %>" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="shippingPhone" class="form-label">Số điện thoại</label>
                                    <input type="text" class="form-control" id="shippingPhone" name="shippingPhone"
                                        value="<%= shippingData.phone || '' %>" required>
                                </div>
                            </div>
                            <div class="floating-label mb-3">
                                <label for="shippingAddress" class="form-label">Địa chỉ giao hàng</label>
                                <textarea class="form-control" id="shippingAddress" name="shippingAddress" rows="3"
                                    required><%= shippingData.address || '' %></textarea>
                            </div>
                            <div class="floating-label mb-4">
                                <label for="note" class="form-label">Ghi chú (tuỳ chọn)</label>
                                <textarea class="form-control" id="note" name="note" rows="2"><%= shippingData.note || '' %></textarea>
                            </div>

                            <h3 class="mb-3 text-uppercase" style="letter-spacing: 0.2em;">Phương thức thanh toán</h3>
                            <div class="d-flex flex-column flex-md-row gap-3">
                                <label class="payment-card flex-fill <%= selectedPayment === ' COD' ? 'selected' : ''
                                                                            %>" data-payment="COD">
                                                                            <input type="radio" name="paymentMethod"
                                                                                value="COD"
                                                                                class="form-check-input me-2"
                                                                                <%=selectedPayment==='COD' ? 'checked'
                                                                                : '' %> hidden>
                                                                            <strong>COD</strong>
                                                                            <p class="mb-0 text-muted">Thanh toán khi
                                                                                nhận hàng</p>
                                                            </label>
                                                            <label
                                                                class="payment-card flex-fill <%= selectedPayment === 'Banking' ? 'selected' : '' %>"
                                                                data-payment="Banking">
                                                                <input type="radio" name="paymentMethod" value="Banking"
                                                                    class="form-check-input me-2"
                                                                    <%=selectedPayment==='Banking' ? 'checked' : '' %>
                                                                hidden>
                                                                <strong>Banking</strong>
                                                                <p class="mb-0 text-muted">Chuyển khoản ngân hàng qua
                                                                    VietQR</p>
                                                            </label>
                                                    </div>
                                                    <div id="qrPaymentPanel"
                                                        class="qr-card mt-3 <%= selectedPayment === 'Banking' ? '' : 'd-none' %>">
                                                        <% if (qrConfig && qrConfig.imageUrl) { %>
                                                            <div
                                                                class="d-flex flex-column flex-md-row gap-4 align-items-start">
                                                                <img src="<%= qrConfig.imageUrl %>" alt="QR thanh toán"
                                                                    class="img-fluid border" loading="lazy">
                                                                <div>
                                                                    <h5 class="mb-2">Quét mã VietQR để chuyển khoản</h5>
                                                                    <p class="mb-1">Ngân hàng: <strong>
                                                                            <%= qrConfig.bankCode %>
                                                                        </strong></p>
                                                                    <p class="mb-1">Số tài khoản: <strong>
                                                                            <%= qrConfig.accountNumber %>
                                                                        </strong></p>
                                                                    <p class="mb-1">Chủ tài khoản: <strong>
                                                                            <%= qrConfig.accountName %>
                                                                        </strong></p>
                                                                    <p class="mb-1">Số tiền: <strong>
                                                                            <%= (qrConfig.amount ||
                                                                                0).toLocaleString('vi-VN', {
                                                                                style: 'currency' , currency: 'VND' })
                                                                                %>
                                                                        </strong></p>
                                                                    <p class="mb-1">Nội dung chuyển khoản:</p>
                                                                    <p class="fw-semibold" id="qrTransferNote">
                                                                        <%= qrConfig.transferNote %>
                                                                    </p>
                                                                    <small class="text-muted d-block">Vui lòng giữ
                                                                        nguyên nội dung chuyển khoản để hệ thống tự động
                                                                        xác thực.</small>
                                                                </div>
                                                            </div>
                                                            <% } else { %>
                                                                <p class="mb-0 text-muted">Thông tin QR chưa sẵn sàng.
                                                                    Vui lòng thử lại sau hoặc chọn hình thức thanh toán
                                                                    khác.</p>
                                                                <% } %>
                                                    </div>
                                    </section>

                                    <aside class="summary-column">
                                        <div class="summary-card">
                                            <h5 class="text-uppercase mb-3" style="letter-spacing: 0.2em;">Tổng quan đơn
                                                hàng</h5>
                                            <div class="mb-3">
                                                <% cart.items.forEach(function(item){ %>
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div>
                                                            <p class="mb-0 fw-semibold">
                                                                <%= item.name %>
                                                            </p>
                                                            <% if (item.variantLabel) { %>
                                                                <small class="text-muted">
                                                                    <%= item.variantLabel %>
                                                                </small>
                                                                <% } %>
                                                        </div>
                                                        <p class="mb-0">
                                                            <%= item.quantity %> x <%=
                                                                    item.price.toLocaleString('vi-VN', {
                                                                    style: 'currency' , currency: 'VND' }) %>
                                                        </p>
                                                    </div>
                                                    <% }) %>
                                            </div>
                                            <hr>
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <span class="text-muted">Tạm tính</span>
                                                <strong>
                                                    <%= cart.subtotal.toLocaleString('vi-VN', { style: 'currency' ,
                                                        currency: 'VND' }) %>
                                                </strong>
                                            </div>
                                            <button class="btn btn-dark w-100 py-3 text-uppercase"
                                                style="letter-spacing: 0.2em;">
                                                Đặt hàng
                                            </button>
                                        </div>
                                    </aside>
                                </form>
                                <% } %>
            </div>
        </main>

        <%- include('partials/footer') %>

            <script id="checkout-data" type="application/json">
        <%- JSON.stringify({
            cart: cart || { items: [], subtotal: 0 },
            userId: currentUser ? currentUser.id : null,
          }) %>
    </script>
            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    const addressRadios = document.querySelectorAll('input[name="addressId"]');
                    const nameInput = document.getElementById("shippingName");
                    const phoneInput = document.getElementById("shippingPhone");
                    const addressInput = document.getElementById("shippingAddress");
                    const paymentCards = document.querySelectorAll(".payment-card");
                    const qrPanel = document.getElementById("qrPaymentPanel");
                    const form = document.getElementById("checkoutForm");
                    const feedbackBox = document.getElementById("checkoutFeedback");
                    const checkoutDataNode = document.getElementById("checkout-data");
                    let checkoutData = {};

                    const showFeedback = (type, message) => {
                        if (!feedbackBox) return;
                        feedbackBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                    };

                    if (checkoutDataNode) {
                        try {
                            checkoutData = JSON.parse(checkoutDataNode.textContent || "{}") || {};
                        } catch (error) {
                            checkoutData = {};
                        }
                    }

                    if (addressRadios.length && nameInput && phoneInput && addressInput) {
                        addressRadios.forEach((radio) => {
                            radio.addEventListener("change", () => {
                                nameInput.value = radio.dataset.name || "";
                                phoneInput.value = radio.dataset.phone || "";
                                addressInput.value = radio.dataset.address || "";
                            });
                            if (radio.checked) {
                                radio.dispatchEvent(new Event("change"));
                            }
                        });
                    }

                    const toggleQrPanel = (method) => {
                        if (!qrPanel) return;
                        if (method === "Banking") {
                            qrPanel.classList.remove("d-none");
                        } else {
                            qrPanel.classList.add("d-none");
                        }
                    };

                    paymentCards.forEach((card) => {
                        card.addEventListener("click", () => {
                            paymentCards.forEach((c) => c.classList.remove("selected"));
                            card.classList.add("selected");
                            const input = card.querySelector('input[name="paymentMethod"]');
                            if (input) {
                                input.checked = true;
                                toggleQrPanel(card.dataset.payment);
                            }
                        });
                        const input = card.querySelector('input[name="paymentMethod"]');
                        if (input && input.checked) {
                            card.classList.add("selected");
                            toggleQrPanel(card.dataset.payment);
                        }
                    });

                    const placeOrderBtn =
                        form && form.querySelector(".summary-card button[type='submit']");

                    const cartItems =
                        (checkoutData.cart && Array.isArray(checkoutData.cart.items)
                            ? checkoutData.cart.items
                            : []);

                    if (form && cartItems.length) {
                        const originalBtnText = placeOrderBtn ? placeOrderBtn.textContent : "";
                        form.addEventListener("submit", async (event) => {
                            event.preventDefault();
                            const formData = new FormData(form);
                            const payload = {
                                items: cartItems.map((item) => ({
                                    skuId: item.skuId,
                                    quantity: item.quantity,
                                })),
                                shippingName: formData.get("shippingName") || "",
                                shippingPhone: formData.get("shippingPhone") || "",
                                shippingAddress: formData.get("shippingAddress") || "",
                                paymentMethod: formData.get("paymentMethod") || "COD",
                                note: formData.get("note") || "",
                            };

                            if (placeOrderBtn) {
                                placeOrderBtn.disabled = true;
                                placeOrderBtn.textContent = "Đang xử lý...";
                            }
                            showFeedback("info", "Đang xử lý đơn hàng của bạn...");

                            try {
                                const response = await fetch("/api/orders", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify(payload),
                                    credentials: "same-origin",
                                });
                                const result = await response.json();
                                if (!response.ok) {
                                    throw new Error(result.message || "Không thể đặt hàng.");
                                }
                                showFeedback(
                                    "success",
                                    "Đặt hàng thành công! Đang chuyển tới lịch sử đơn hàng..."
                                );
                                setTimeout(() => {
                                    if (checkoutData.userId) {
                                        window.location.href = `/user/profile/${checkoutData.userId}`;
                                    } else {
                                        window.location.href = "/products";
                                    }
                                }, 1200);
                            } catch (error) {
                                showFeedback(
                                    "danger",
                                    error.message || "Không thể đặt hàng. Vui lòng thử lại."
                                );
                                if (placeOrderBtn) {
                                    placeOrderBtn.disabled = false;
                                    placeOrderBtn.textContent = originalBtnText || "Đặt hàng";
                                }
                            }
                        });
                    }
                });
            </script>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>