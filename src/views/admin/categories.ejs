<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moda Studio | Quản lý danh mục</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
</head>

<body class="<%= theme === 'dark' ? 'theme-dark' : 'theme-light' %>">
    <%- include('../partials/header') %>
        <main class="site-main py-5">
            <div class="container pt-5">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <p class="text-muted text-uppercase mb-1" style="letter-spacing: 0.3em;">Admin</p>
                        <h2 class="fw-bold">Quản lý danh mục</h2>
                    </div>
                </div>
                <div class="admin-subnav mb-4" data-role="<%= currentUser ? currentUser.roleId : '' %>">
                    <div id="admin-sidebar-root"></div>
                </div>

                <% if (successMessage) { %>
                    <div class="alert alert-success">
                        <%= successMessage %>
                    </div>
                    <% } %>
                        <% if (errorMessage) { %>
                            <div class="alert alert-danger">
                                <%= errorMessage %>
                            </div>
                            <% } %>

                                <div class="row">
                                    <div class="col-lg-4 mb-4">
                                        <div class="card shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                                    <%= editingCategory ? "Chỉnh sửa danh mục" : "Tạo danh mục mới" %>
                                                </h5>
                                                <form
                                                    action="<%= editingCategory ? `/admin/categories/${editingCategory.id}` : '/admin/categories' %>"
                                                    method="POST" enctype="multipart/form-data">
                                                    <div class="mb-3">
                                                        <label class="form-label">Tên danh mục</label>
                                                        <input type="text" name="name" class="form-control"
                                                            value="<%= editingCategory ? editingCategory.name : (formData && formData.name) || '' %>"
                                                            required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Slug</label>
                                                        <input type="text" name="slug" class="form-control"
                                                            placeholder="để trống để tự tạo"
                                                            value="<%= editingCategory ? editingCategory.slug : (formData && formData.slug) || '' %>">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Danh mục cha</label>
                                                        <select name="parentId" class="form-select">
                                                            <option value="">-- Không --</option>
                                                            <% categories.forEach(function(category) { %>
                                                                <% if (!editingCategory || String(category.id)
                                                                    !==String(editingCategory.id)) { %>
                                                                    <option value="<%= category.id %>"
                                                                        <%=editingCategory &&
                                                                        String(editingCategory.parentId)===String(category.id)
                                                                        ? 'selected' : (formData &&
                                                                        String(formData.parentId)===String(category.id)
                                                                        ? 'selected' : '' ) %>>
                                                                        <%= category.name %>
                                                                    </option>
                                                                    <% } %>
                                                                        <% }) %>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Ảnh hiển thị</label>
                                                        <input type="file" name="image" class="form-control"
                                                            accept="image/*">
                                                        <% if (editingCategory && editingCategory.imageUrl) { %>
                                                            <img src="<%= editingCategory.imageUrl %>"
                                                                alt="<%= editingCategory.name %>"
                                                                class="img-fluid rounded mt-2"
                                                                style="max-height: 120px;">
                                                            <% } %>
                                                    </div>
                                                    <div class="d-flex gap-2">
                                                        <button type="submit" class="btn btn-dark flex-grow-1">
                                                            <%= editingCategory ? "Cập nhật" : "Tạo mới" %>
                                                        </button>
                                                        <% if (editingCategory) { %>
                                                            <a href="/admin/categories"
                                                                class="btn btn-outline-secondary">Huỷ</a>
                                                            <% } %>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-8">
                                        <div class="card shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">Danh sách danh mục</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-hover align-middle">
                                                        <thead>
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Tên</th>
                                                                <th>Slug</th>
                                                                <th>Danh mục cha</th>
                                                                <th>Ảnh</th>
                                                                <th></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% if (categories && categories.length) { %>
                                                                <% categories.forEach(function(category) { %>
                                                                    <tr>
                                                                        <td>
                                                                            <%= category.id %>
                                                                        </td>
                                                                        <td>
                                                                            <%= category.name %>
                                                                        </td>
                                                                        <td>
                                                                            <%= category.slug %>
                                                                        </td>
                                                                        <td>
                                                                            <% const parent=categories.find((item)=>
                                                                                String(item.id) ===
                                                                                String(category.parentId)); %>
                                                                                <%= parent ? parent.name : "-" %>
                                                                        </td>
                                                                        <td>
                                                                            <% if (category.imageUrl) { %>
                                                                                <img src="<%= category.imageUrl %>"
                                                                                    alt="<%= category.name %>"
                                                                                    class="rounded"
                                                                                    style="height: 48px;">
                                                                                <% } else { %>
                                                                                    <span class="text-muted">No
                                                                                        image</span>
                                                                                    <% } %>
                                                                        </td>
                                                                        <td class="text-end">
                                                                            <a class="btn btn-sm btn-outline-dark"
                                                                                href="/admin/categories/<%= category.id %>/edit">Edit</a>
                                                                            <form class="d-inline-block" method="POST"
                                                                                action="/admin/categories/<%= category.id %>/delete"
                                                                                onsubmit="return confirm('Xoá danh mục này?');">
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    type="submit">Delete</button>
                                                                            </form>
                                                                        </td>
                                                                    </tr>
                                                                    <% }) %>
                                                                        <% } else { %>
                                                                            <tr>
                                                                                <td colspan="6"
                                                                                    class="text-center text-muted">Chưa
                                                                                    có danh mục nào.</td>
                                                                            </tr>
                                                                            <% } %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
            </div>
        </main>
        <%- include('../partials/footer') %>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
            <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
            <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
            <script type="text/babel" data-presets="env,react" data-plugins="proposal-class-properties,proposal-object-rest-spread,proposal-optional-chaining,proposal-nullish-coalescing-operator" src="/js/AdminSidebar.jsx"></script>
</body>

</html>