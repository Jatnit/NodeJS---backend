<!doctype html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moda Studio | Quản lý sản phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
</head>

<body class="<%= theme === 'dark' ? 'theme-dark' : 'theme-light' %>">
    <%- include('../partials/admin-layout-init') %>
        <%- include('../partials/header') %>

            <div class="admin-subnav" data-role="<%= currentUser ? currentUser.roleId : '' %>"
                data-username="<%= currentUser ? (currentUser.username || currentUser.email) : '' %>">
                <div id="admin-sidebar-root"></div>
            </div>

            <main class="admin-content-wrapper">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
                    <div>
                        <p class="text-muted text-uppercase mb-1" style="letter-spacing: 0.3em; font-size: 0.75rem;">
                            Admin
                        </p>
                        <h2 class="fw-bold mb-0">Quản lý sản phẩm</h2>
                        <small class="text-muted">Thêm, sửa, xoá sản phẩm và quản lý tồn kho.</small>
                    </div>
                </div>

                <% if (successMessage) { %>
                    <div class="alert alert-success d-flex align-items-center gap-2" style="border-radius: 12px;">
                        <i class="bi bi-check-circle"></i>
                        <%= successMessage %>
                    </div>
                    <% } %>
                        <% if (errorMessage) { %>
                            <div class="alert alert-danger d-flex align-items-center gap-2"
                                style="border-radius: 12px;">
                                <i class="bi bi-exclamation-triangle"></i>
                                <%= errorMessage %>
                            </div>
                            <% } %>

                                <div class="row g-4">
                                    <!-- Form Card -->
                                    <div class="col-lg-5">
                                        <div class="card border-0 shadow-sm" style="border-radius: 16px;">
                                            <div class="card-body p-4">
                                                <div class="d-flex align-items-center gap-3 mb-4">
                                                    <div class="d-flex align-items-center justify-content-center"
                                                        style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                                        <i class="bi bi-box-seam text-white"
                                                            style="font-size: 20px;"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="fw-bold mb-0">
                                                            <%= editingProduct ? "Chỉnh sửa sản phẩm" : "Thêm sản phẩm"
                                                                %>
                                                        </h5>
                                                        <small class="text-muted">Điền thông tin bên dưới</small>
                                                    </div>
                                                </div>

                                                <form
                                                    action="<%= editingProduct ? `/admin/products/${editingProduct.id}` : '/admin/products' %>"
                                                    method="POST" enctype="multipart/form-data">

                                                    <!-- Basic Info -->
                                                    <div class="mb-4 p-3 bg-light rounded-3">
                                                        <h6 class="fw-semibold text-muted mb-3">
                                                            <i class="bi bi-info-circle me-2"></i>Thông tin cơ bản
                                                        </h6>
                                                        <div class="mb-3">
                                                            <label class="form-label small fw-semibold text-muted">TÊN
                                                                SẢN
                                                                PHẨM</label>
                                                            <input type="text" name="name" id="productName"
                                                                class="form-control"
                                                                value="<%= editingProduct ? editingProduct.name : (formData && formData.name) || '' %>"
                                                                required placeholder="VD: Áo khoác denim"
                                                                style="border-radius: 10px; padding: 12px;">
                                                            <div id="nameError" class="text-danger small mt-1"
                                                                style="display:none;">
                                                                <i
                                                                    class="bi bi-exclamation-circle me-1"></i><span></span>
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label
                                                                class="form-label small fw-semibold text-muted">SLUG</label>
                                                            <input type="text" name="slug" id="productSlug"
                                                                class="form-control" placeholder="Để trống để tự tạo"
                                                                value="<%= editingProduct ? editingProduct.slug : (formData && formData.slug) || '' %>"
                                                                style="border-radius: 10px; padding: 12px;">
                                                            <div id="slugError" class="text-danger small mt-1"
                                                                style="display:none;">
                                                                <i
                                                                    class="bi bi-exclamation-circle me-1"></i><span></span>
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label small fw-semibold text-muted">GIÁ
                                                                (VND)</label>
                                                            <input type="number" name="basePrice" min="0"
                                                                class="form-control"
                                                                value="<%= editingProduct ? editingProduct.basePrice : (formData && formData.basePrice) || '' %>"
                                                                required placeholder="0"
                                                                style="border-radius: 10px; padding: 12px;">
                                                        </div>
                                                        <div class="mb-0">
                                                            <label class="form-label small fw-semibold text-muted">MÔ
                                                                TẢ</label>
                                                            <textarea name="description" rows="3" class="form-control"
                                                                placeholder="Mô tả sản phẩm..."
                                                                style="border-radius: 10px; padding: 12px;"><%= editingProduct ? editingProduct.description || '' : (formData && formData.description) || '' %></textarea>
                                                        </div>
                                                    </div>

                                                    <!-- Category & Status -->
                                                    <div class="mb-4 p-3 bg-light rounded-3">
                                                        <h6 class="fw-semibold text-muted mb-3">
                                                            <i class="bi bi-tag me-2"></i>Phân loại & Trạng thái
                                                        </h6>
                                                        <div class="mb-3">
                                                            <label class="form-label small fw-semibold text-muted">DANH
                                                                MỤC</label>
                                                            <select name="categoryIds" class="form-select" multiple
                                                                size="4" style="border-radius: 10px; padding: 10px;">
                                                                <% const selectedCats=editingProduct ?
                                                                    editingProduct.categoryIds : (formData &&
                                                                    formData.categoryIds); %>
                                                                    <% categories.forEach(function(category) { %>
                                                                        <option value="<%= category.id %>"
                                                                            <%=selectedCats &&
                                                                            selectedCats.includes(String(category.id))
                                                                            ? 'selected' : '' %>>
                                                                            <%= category.name %>
                                                                        </option>
                                                                        <% }) %>
                                                            </select>
                                                            <small class="text-muted">Giữ Ctrl/Cmd để chọn nhiều</small>
                                                        </div>
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox"
                                                                id="isActive" name="isActive" <%=editingProduct ?
                                                                (editingProduct.isActive ? 'checked' : '' ) : 'checked'
                                                                %>>
                                                            <label class="form-check-label" for="isActive">Hiển thị sản
                                                                phẩm</label>
                                                        </div>
                                                    </div>

                                                    <!-- Images -->
                                                    <div class="mb-4 p-3 bg-light rounded-3">
                                                        <h6 class="fw-semibold text-muted mb-3">
                                                            <i class="bi bi-image me-2"></i>Hình ảnh
                                                        </h6>
                                                        <div class="mb-3">
                                                            <label class="form-label small fw-semibold text-muted">ẢNH
                                                                THUMBNAIL</label>
                                                            <input type="file" name="thumbnail" class="form-control"
                                                                accept="image/*"
                                                                style="border-radius: 10px; padding: 10px;">
                                                            <% if (editingProduct && editingProduct.thumbnailUrl) { %>
                                                                <img src="<%= editingProduct.thumbnailUrl %>"
                                                                    alt="<%= editingProduct.name %>"
                                                                    class="rounded mt-2" style="max-height: 80px;">
                                                                <% } %>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label small fw-semibold text-muted">BỘ
                                                                SƯU
                                                                TẬP (3 ảnh)</label>
                                                            <input type="file" name="galleryImages" class="form-control"
                                                                accept="image/*" multiple
                                                                style="border-radius: 10px; padding: 10px;">
                                                            <% if (editingProduct && editingProduct.galleries &&
                                                                editingProduct.galleries.length) { %>
                                                                <div class="d-flex flex-wrap gap-2 mt-2">
                                                                    <% editingProduct.galleries.forEach(function(gallery)
                                                                        { %>
                                                                        <img src="<%= gallery.imageUrl %>" alt="gallery"
                                                                            class="rounded"
                                                                            style="width: 60px; height: 60px; object-fit: cover;">
                                                                        <% }) %>
                                                                </div>
                                                                <% } %>
                                                        </div>
                                                        <div class="mb-0">
                                                            <label class="form-label small fw-semibold text-muted">
                                                                <i class="bi bi-palette me-1"></i>MÀU SẮC & TỒN KHO
                                                            </label>
                                                            <div id="color-inventory-list"
                                                                class="d-flex flex-column gap-3">
                                                                <!-- Color Inventory Block Template -->
                                                                <div
                                                                    class="color-inventory-block border rounded-3 p-3 bg-white">
                                                                    <!-- Top row: Color select + File input + Remove button -->
                                                                    <div class="d-flex gap-2 align-items-center mb-3">
                                                                        <select name="colorImageColorIds[]"
                                                                            class="form-select form-select-sm"
                                                                            style="border-radius: 8px; max-width: 150px;">
                                                                            <option value="">Chọn màu</option>
                                                                            <% colorOptions.forEach(function(color) { %>
                                                                                <option value="<%= color.id %>">
                                                                                    <%= color.value %>
                                                                                </option>
                                                                                <% }) %>
                                                                        </select>
                                                                        <input type="file" name="colorImageFiles"
                                                                            class="form-control form-control-sm"
                                                                            accept="image/*"
                                                                            style="border-radius: 8px;">
                                                                        <button type="button"
                                                                            class="btn btn-sm btn-outline-danger remove-color-block"
                                                                            style="border-radius: 8px;">
                                                                            <i class="bi bi-trash"></i>
                                                                        </button>
                                                                    </div>
                                                                    <!-- Bottom row: Size inventory table -->
                                                                    <div class="size-inventory-row">
                                                                        <div class="d-flex gap-2 flex-wrap">
                                                                            <% sizeOptions.forEach(function(size) { %>
                                                                                <div class="size-cell text-center p-2 bg-light rounded"
                                                                                    style="min-width: 80px; flex: 1;">
                                                                                    <div
                                                                                        class="small fw-semibold text-muted mb-1">
                                                                                        <%= size.value %>
                                                                                    </div>
                                                                                    <input type="number" step="1000"
                                                                                        class="form-control form-control-sm mb-1 price-input"
                                                                                        placeholder="Giá"
                                                                                        data-size-id="<%= size.id %>"
                                                                                        style="font-size: 11px;">
                                                                                    <input type="number" min="0"
                                                                                        class="form-control form-control-sm stock-input"
                                                                                        placeholder="SL"
                                                                                        data-size-id="<%= size.id %>"
                                                                                        style="font-size: 11px;">
                                                                                </div>
                                                                                <% }) %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <button type="button"
                                                                class="btn btn-outline-secondary btn-sm mt-3"
                                                                id="addColorInventoryBlock" style="border-radius: 8px;">
                                                                <i class="bi bi-plus me-1"></i>Thêm màu
                                                            </button>
                                                            <small class="text-muted d-block mt-2">Bỏ trống giá để dùng
                                                                giá cơ bản.</small>
                                                            <% if (editingProduct && editingProduct.colorImages &&
                                                                editingProduct.colorImages.length) { %>
                                                                <div class="d-flex flex-wrap gap-2 mt-2">
                                                                    <% editingProduct.colorImages.forEach(function(img)
                                                                        { %>
                                                                        <div class="border rounded p-2 text-center"
                                                                            style="width: 80px;">
                                                                            <img src="<%= img.imageUrl %>" alt="color"
                                                                                class="rounded"
                                                                                style="height: 50px; object-fit: cover;">
                                                                        </div>
                                                                        <% }) %>
                                                                </div>
                                                                <% } %>
                                                        </div>
                                                    </div>

                                                    <div class="d-flex gap-2">
                                                        <button type="submit" class="btn btn-dark flex-grow-1"
                                                            style="border-radius: 10px; padding: 12px;">
                                                            <i
                                                                class="bi <%= editingProduct ? 'bi-check-lg' : 'bi-plus-lg' %> me-2"></i>
                                                            <%= editingProduct ? "Cập nhật" : "Thêm mới" %>
                                                        </button>
                                                        <% if (editingProduct) { %>
                                                            <a href="/admin/products" class="btn btn-outline-secondary"
                                                                style="border-radius: 10px; padding: 12px;">Huỷ</a>
                                                            <% } %>
                                                    </div>
                                                </form>

                                                <% if (editingProduct) { %>
                                                    <div class="mt-4 p-3 border rounded-3">
                                                        <h6 class="fw-semibold mb-2">
                                                            <i class="bi bi-box-seam me-2"></i>Inventory Matrix
                                                        </h6>
                                                        <div id="inventory-matrix-root"
                                                            data-product-id="<%= editingProduct.id %>">
                                                            <div class="text-muted text-center py-3 small">Đang tải...
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Table Card -->
                                    <div class="col-lg-7">
                                        <div class="card border-0 shadow-sm" style="border-radius: 16px;">
                                            <div class="card-body p-4">
                                                <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
                                                    <div>
                                                        <h5 class="fw-bold mb-1">Danh sách sản phẩm</h5>
                                                        <p class="text-muted small mb-0">
                                                            Tổng cộng <%= products ? products.length : 0 %> sản phẩm
                                                        </p>
                                                    </div>
                                                    <div class="d-flex align-items-center gap-2 flex-wrap">
                                                        <!-- Bulk Actions -->
                                                        <select id="bulkActionSelect" class="form-select form-select-sm" style="width: auto; border-radius: 8px;">
                                                            <option value="">-- Hành động --</option>
                                                            <option value="activate">Bật hoạt động</option>
                                                            <option value="deactivate">Tắt hoạt động</option>
                                                            <option value="delete">Xóa</option>
                                                        </select>
                                                        <button type="button" id="bulkActionBtn" class="btn btn-sm btn-dark" disabled style="border-radius: 8px;">
                                                            <i class="bi bi-play-fill me-1"></i>Thực hiện
                                                        </button>
                                                        <div class="d-flex align-items-center gap-2 px-3 py-2 rounded-pill"
                                                            style="background: #ecfdf5; color: #047857;">
                                                            <i class="bi bi-box-seam"></i>
                                                            <span class="small fw-semibold">
                                                                <%= products ? products.length : 0 %>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Selected count indicator -->
                                                <div id="selectedCountBar" class="alert alert-info py-2 px-3 d-none mb-3" style="border-radius: 10px;">
                                                    <i class="bi bi-check2-square me-2"></i>
                                                    <span id="selectedCountText">0 sản phẩm được chọn</span>
                                                </div>

                                                <div class="table-responsive">
                                                    <table class="table table-hover align-middle mb-0" id="productsTable">
                                                        <thead>
                                                            <tr class="text-muted small text-uppercase"
                                                                style="letter-spacing: 0.05em;">
                                                                <th class="border-0 py-3" style="width: 40px;">
                                                                    <input type="checkbox" id="selectAllProducts" class="form-check-input" style="cursor: pointer;">
                                                                </th>
                                                                <th class="border-0 py-3">Sản phẩm</th>
                                                                <th class="border-0 py-3 text-end">Giá</th>
                                                                <th class="border-0 py-3">Trạng thái</th>
                                                                <th class="border-0 py-3 text-end">Thao tác</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% if (products && products.length) { %>
                                                                <% products.forEach(function(product) { %>
                                                                    <tr data-product-id="<%= product.id %>">
                                                                        <td class="py-3">
                                                                            <input type="checkbox" class="form-check-input product-checkbox" 
                                                                                value="<%= product.id %>" style="cursor: pointer;">
                                                                        </td>
                                                                        <td class="py-3">
                                                                            <div
                                                                                class="d-flex align-items-center gap-3">
                                                                                <% if (product.thumbnailUrl) { %>
                                                                                    <img src="<%= product.thumbnailUrl %>"
                                                                                        alt="<%= product.name %>"
                                                                                        class="rounded"
                                                                                        style="width: 56px; height: 56px; object-fit: cover;">
                                                                                    <% } else { %>
                                                                                        <div class="d-flex align-items-center justify-content-center rounded"
                                                                                            style="width: 56px; height: 56px; background: #f3f4f6;">
                                                                                            <i
                                                                                                class="bi bi-image text-muted"></i>
                                                                                        </div>
                                                                                        <% } %>
                                                                                            <div>
                                                                                                <div
                                                                                                    class="fw-semibold">
                                                                                                    <%= product.name %>
                                                                                                </div>
                                                                                                <small
                                                                                                    class="text-muted">ID:
                                                                                                    #
                                                                                                    <%= product.id %>
                                                                                                </small>
                                                                                            </div>
                                                                            </div>
                                                                        </td>
                                                                        <td class="py-3 text-end fw-semibold">
                                                                            <%= Number(product.basePrice ||
                                                                                0).toLocaleString('vi-VN', {
                                                                                style: 'currency' , currency: 'VND' })
                                                                                %>
                                                                        </td>
                                                                        <td class="py-3">
                                                                            <% if (product.isActive) { %>
                                                                                <span class="badge fw-semibold"
                                                                                    style="background: #d1fae5; color: #065f46; padding: 6px 12px; border-radius: 20px;">
                                                                                    <i
                                                                                        class="bi bi-check-circle me-1"></i>Active
                                                                                </span>
                                                                                <% } else { %>
                                                                                    <span class="badge fw-semibold"
                                                                                        style="background: #f3f4f6; color: #6b7280; padding: 6px 12px; border-radius: 20px;">
                                                                                        <i
                                                                                            class="bi bi-eye-slash me-1"></i>Ẩn
                                                                                    </span>
                                                                                    <% } %>
                                                                        </td>
                                                                        <td class="py-3 text-end">
                                                                            <a class="btn btn-sm btn-outline-dark me-1"
                                                                                style="border-radius: 8px;"
                                                                                href="/admin/products/<%= product.id %>/edit">
                                                                                <i class="bi bi-pencil"></i>
                                                                            </a>
                                                                            <form class="d-inline" method="POST"
                                                                                action="/admin/products/<%= product.id %>/delete"
                                                                                onsubmit="return confirm('Xác nhận xoá sản phẩm này?');">
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    type="submit"
                                                                                    style="border-radius: 8px;">
                                                                                    <i class="bi bi-trash"></i>
                                                                                </button>
                                                                            </form>
                                                                        </td>
                                                                    </tr>
                                                                    <% }) %>
                                                                        <% } else { %>
                                                                            <tr>
                                                                                <td colspan="5"
                                                                                    class="text-center py-5 text-muted">
                                                                                    <i class="bi bi-box"
                                                                                        style="font-size: 48px;"></i>
                                                                                    <p class="mt-2 mb-0">Chưa có sản
                                                                                        phẩm
                                                                                        nào</p>
                                                                                </td>
                                                                            </tr>
                                                                            <% } %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </div>
            </main>

            <%- include('../partials/footer') %>

                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
                <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
                <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
                <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
                <script type="text/babel" data-presets="env,react"
                    data-plugins="proposal-class-properties,proposal-object-rest-spread,proposal-optional-chaining,proposal-nullish-coalescing-operator"
                    src="/js/admin/Sidebar.jsx"></script>
                <script>
                    // Color Inventory Block Management
                    (function () {
                        const list = document.getElementById("color-inventory-list");
                        const addBtn = document.getElementById("addColorInventoryBlock");
                        if (!list || !addBtn) return;

                        // Update inventory input names when color is selected
                        const updateInventoryNames = (block) => {
                            const select = block.querySelector("select");
                            const colorId = select ? select.value : "";

                            // Update price inputs
                            block.querySelectorAll(".price-input").forEach((input) => {
                                const sizeId = input.dataset.sizeId;
                                if (colorId && sizeId) {
                                    input.name = `inventory[${colorId}][${sizeId}][price]`;
                                } else {
                                    input.name = "";
                                }
                            });

                            // Update stock inputs
                            block.querySelectorAll(".stock-input").forEach((input) => {
                                const sizeId = input.dataset.sizeId;
                                if (colorId && sizeId) {
                                    input.name = `inventory[${colorId}][${sizeId}][stock]`;
                                } else {
                                    input.name = "";
                                }
                            });
                        };

                        // Ensure color select name is set only when file is selected
                        const ensureSelectName = (block) => {
                            const select = block.querySelector("select");
                            const fileInput = block.querySelector('input[type="file"]');
                            if (!select || !fileInput) return;
                            if (!select.dataset.originalName) {
                                select.dataset.originalName = select.name || "colorImageColorIds[]";
                            }
                            select.name = fileInput.files && fileInput.files.length > 0 ? select.dataset.originalName : "";
                        };

                        const bindBlockEvents = (block) => {
                            const select = block.querySelector("select");
                            const fileInput = block.querySelector('input[type="file"]');

                            // When color changes, update inventory input names
                            if (select) {
                                select.addEventListener("change", () => {
                                    updateInventoryNames(block);
                                });
                            }

                            // When file is selected, ensure select name is set
                            if (fileInput) {
                                fileInput.addEventListener("change", () => ensureSelectName(block));
                                ensureSelectName(block);
                            }

                            // Remove button
                            const removeBtn = block.querySelector(".remove-color-block");
                            if (removeBtn) {
                                removeBtn.addEventListener("click", () => {
                                    if (list.children.length > 1) {
                                        block.remove();
                                    } else {
                                        // Reset the block instead of removing
                                        block.querySelectorAll("input").forEach((input) => (input.value = ""));
                                        const sel = block.querySelector("select");
                                        if (sel) sel.selectedIndex = 0;
                                        updateInventoryNames(block);
                                    }
                                });
                            }

                            // Initial update
                            updateInventoryNames(block);
                        };

                        // Bind events to existing blocks
                        Array.from(list.children).forEach((block) => bindBlockEvents(block));

                        // Add new block button
                        addBtn.addEventListener("click", () => {
                            const template = list.querySelector(".color-inventory-block");
                            if (!template) return;
                            const clone = template.cloneNode(true);
                            // Clear all inputs
                            clone.querySelectorAll("input").forEach((input) => (input.value = ""));
                            const select = clone.querySelector("select");
                            if (select) select.selectedIndex = 0;
                            list.appendChild(clone);
                            bindBlockEvents(clone);
                        });
                    })();
                </script>

                <!-- Duplicate Check Script -->
                <script>
                    (function () {
                        const nameInput = document.getElementById('productName');
                        const slugInput = document.getElementById('productSlug');
                        const nameError = document.getElementById('nameError');
                        const slugError = document.getElementById('slugError');
                        const form = nameInput?.closest('form');
                        const editingProductId = '<%= editingProduct ? editingProduct.id : "" %>';

                        let checkTimeout = null;
                        let isNameValid = true;
                        let isSlugValid = true;

                        const showError = (errorDiv, message) => {
                            if (errorDiv && message) {
                                errorDiv.querySelector('span').textContent = message;
                                errorDiv.style.display = 'block';
                            }
                        };

                        const hideError = (errorDiv) => {
                            if (errorDiv) {
                                errorDiv.style.display = 'none';
                            }
                        };

                        const setInputState = (input, isValid) => {
                            if (input) {
                                input.style.borderColor = isValid ? '' : '#dc3545';
                                input.style.boxShadow = isValid ? '' : '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
                            }
                        };

                        const checkDuplicate = async (field, value) => {
                            if (!value || !value.trim()) {
                                if (field === 'name') {
                                    hideError(nameError);
                                    setInputState(nameInput, true);
                                    isNameValid = true;
                                } else {
                                    hideError(slugError);
                                    setInputState(slugInput, true);
                                    isSlugValid = true;
                                }
                                return;
                            }

                            try {
                                const params = new URLSearchParams();
                                params.set(field, value);
                                if (editingProductId) {
                                    params.set('excludeId', editingProductId);
                                }

                                const response = await fetch(`/api/products/check-duplicate?${params.toString()}`);
                                const data = await response.json();

                                if (field === 'name') {
                                    if (data.nameExists) {
                                        showError(nameError, 'Tên sản phẩm này đã tồn tại!');
                                        setInputState(nameInput, false);
                                        isNameValid = false;
                                    } else {
                                        hideError(nameError);
                                        setInputState(nameInput, true);
                                        isNameValid = true;
                                    }
                                } else if (field === 'slug') {
                                    if (data.slugExists) {
                                        showError(slugError, 'Slug này đã tồn tại! Vui lòng đổi slug khác.');
                                        setInputState(slugInput, false);
                                        isSlugValid = false;
                                    } else {
                                        hideError(slugError);
                                        setInputState(slugInput, true);
                                        isSlugValid = true;
                                    }
                                }
                            } catch (error) {
                                console.error('Duplicate check error:', error);
                            }
                        };

                        const debounceCheck = (field, value) => {
                            clearTimeout(checkTimeout);
                            checkTimeout = setTimeout(() => checkDuplicate(field, value), 500);
                        };

                        if (nameInput) {
                            nameInput.addEventListener('blur', () => checkDuplicate('name', nameInput.value));
                            nameInput.addEventListener('input', () => debounceCheck('name', nameInput.value));
                        }

                        if (slugInput) {
                            slugInput.addEventListener('blur', () => checkDuplicate('slug', slugInput.value));
                            slugInput.addEventListener('input', () => debounceCheck('slug', slugInput.value));
                        }

                        // Prevent form submit if there are duplicates
                        if (form) {
                            form.addEventListener('submit', (e) => {
                                if (!isNameValid || !isSlugValid) {
                                    e.preventDefault();
                                    alert('Vui lòng sửa các lỗi trùng lặp trước khi lưu sản phẩm.');
                                    return false;
                                }
                            });
                        }
                    })();
                </script>

                <!-- Bulk Actions Script -->
                <script>
                    (function() {
                        const selectAllCheckbox = document.getElementById('selectAllProducts');
                        const bulkActionSelect = document.getElementById('bulkActionSelect');
                        const bulkActionBtn = document.getElementById('bulkActionBtn');
                        const selectedCountBar = document.getElementById('selectedCountBar');
                        const selectedCountText = document.getElementById('selectedCountText');
                        const productCheckboxes = document.querySelectorAll('.product-checkbox');

                        if (!selectAllCheckbox || !bulkActionSelect || !bulkActionBtn) return;

                        const getSelectedIds = () => {
                            const checked = document.querySelectorAll('.product-checkbox:checked');
                            return Array.from(checked).map(cb => cb.value);
                        };

                        const updateButtonState = () => {
                            const selectedIds = getSelectedIds();
                            const action = bulkActionSelect.value;
                            const hasSelection = selectedIds.length > 0;
                            const hasAction = action !== '';

                            bulkActionBtn.disabled = !(hasSelection && hasAction);

                            // Update selected count bar
                            if (hasSelection) {
                                selectedCountBar.classList.remove('d-none');
                                selectedCountText.textContent = `${selectedIds.length} sản phẩm được chọn`;
                            } else {
                                selectedCountBar.classList.add('d-none');
                            }

                            // Update select all checkbox state
                            const allChecked = productCheckboxes.length > 0 && 
                                Array.from(productCheckboxes).every(cb => cb.checked);
                            const someChecked = Array.from(productCheckboxes).some(cb => cb.checked);
                            selectAllCheckbox.checked = allChecked;
                            selectAllCheckbox.indeterminate = someChecked && !allChecked;
                        };

                        // Select all checkbox
                        selectAllCheckbox.addEventListener('change', () => {
                            productCheckboxes.forEach(cb => {
                                cb.checked = selectAllCheckbox.checked;
                            });
                            updateButtonState();
                        });

                        // Individual checkboxes
                        productCheckboxes.forEach(cb => {
                            cb.addEventListener('change', updateButtonState);
                        });

                        // Action select
                        bulkActionSelect.addEventListener('change', updateButtonState);

                        // Execute bulk action
                        bulkActionBtn.addEventListener('click', async () => {
                            const action = bulkActionSelect.value;
                            const selectedIds = getSelectedIds();

                            if (!action || !selectedIds.length) return;

                            const actionLabels = {
                                'activate': 'bật hoạt động',
                                'deactivate': 'tắt hoạt động',
                                'delete': 'xóa'
                            };

                            const confirmMsg = `Bạn có chắc muốn ${actionLabels[action]} cho ${selectedIds.length} sản phẩm?`;
                            if (!confirm(confirmMsg)) return;

                            bulkActionBtn.disabled = true;
                            bulkActionBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Đang xử lý...';

                            try {
                                const response = await fetch('/api/products/bulk-action', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ action, productIds: selectedIds })
                                });

                                const data = await response.json();

                                if (data.success) {
                                    alert(`Đã ${actionLabels[action]} thành công ${data.affected || selectedIds.length} sản phẩm.`);
                                    window.location.reload();
                                } else {
                                    alert(data.message || 'Có lỗi xảy ra khi thực hiện hành động.');
                                    bulkActionBtn.disabled = false;
                                    bulkActionBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i>Thực hiện';
                                }
                            } catch (error) {
                                console.error('Bulk action error:', error);
                                alert('Có lỗi xảy ra. Vui lòng thử lại.');
                                bulkActionBtn.disabled = false;
                                bulkActionBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i>Thực hiện';
                            }
                        });

                        // Initial state
                        updateButtonState();
                    })();
                </script>

                <% if (editingProduct) { %>
                    <script type="text/babel" data-presets="env,react"
                        data-plugins="proposal-class-properties,proposal-object-rest-spread,proposal-optional-chaining,proposal-nullish-coalescing-operator"
                        src="/js/admin/StockMatrix.jsx"></script>
                    <% } %>
</body>

</html>