<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moda Studio | Quản lý sản phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
</head>

<body class="<%= theme === 'dark' ? 'theme-dark' : 'theme-light' %>">
    <%- include('../partials/header') %>
        <main class="site-main py-5">
            <div class="container pt-5 ">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <p class="text-muted text-uppercase mb-1" style="letter-spacing: 0.3em;">Admin</p>
                        <h2 class="fw-bold">Quản lý sản phẩm</h2>
                    </div>
                    <div class="btn-group">
                        <a class="btn btn-outline-dark" href="/admin/dashboard">Dashboard</a>
                        <a class="btn btn-outline-dark" href="/admin/users">Users</a>
                        <a class="btn btn-outline-dark" href="/admin/categories">Categories</a>
                        <a class="btn btn-dark" href="/admin/products">Products</a>
                    </div>
                </div>

                <% if (successMessage) { %>
                    <div class="alert alert-success">
                        <%= successMessage %>
                    </div>
                    <% } %>
                        <% if (errorMessage) { %>
                            <div class="alert alert-danger">
                                <%= errorMessage %>
                            </div>
                            <% } %>

                                <div class="row">
                                    <div class="col-lg-5 mb-4">
                                        <div class="card shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                                    <%= editingProduct ? "Chỉnh sửa sản phẩm" : "Tạo sản phẩm mới" %>
                                                </h5>
                                                <form
                                                    action="<%= editingProduct ? `/admin/products/${editingProduct.id}` : '/admin/products' %>"
                                                    method="POST" enctype="multipart/form-data">
                                                    <div class="mb-3">
                                                        <label class="form-label">Tên sản phẩm</label>
                                                        <input type="text" name="name" class="form-control"
                                                            value="<%= editingProduct ? editingProduct.name : (formData && formData.name) || '' %>"
                                                            required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Slug</label>
                                                        <input type="text" name="slug" class="form-control"
                                                            placeholder="để trống để tự tạo"
                                                            value="<%= editingProduct ? editingProduct.slug : (formData && formData.slug) || '' %>">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Giá (VND)</label>
                                                        <input type="number" name="basePrice" min="0"
                                                            class="form-control"
                                                            value="<%= editingProduct ? editingProduct.basePrice : (formData && formData.basePrice) || '' %>"
                                                            required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Mô tả</label>
                                                        <textarea name="description" rows="3"
                                                            class="form-control"><%= editingProduct ? editingProduct.description || '' : (formData && formData.description) || '' %></textarea>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Danh mục</label>
                                                        <select name="categoryIds" class="form-select" multiple
                                                            size="6">
                                                            <% const selectedCats=editingProduct ?
                                                                editingProduct.categoryIds : (formData &&
                                                                formData.categoryIds); %>
                                                                <% categories.forEach(function(category){ %>
                                                                    <option value="<%= category.id %>" <%=selectedCats
                                                                        && selectedCats.includes(String(category.id))
                                                                        ? 'selected' : '' %>>
                                                                        <%= category.name %>
                                                                    </option>
                                                                    <% }) %>
                                                        </select>
                                                        <small class="text-muted">Giữ Ctrl / Cmd để chọn nhiều danh
                                                            mục.</small>
                                                    </div>
                                                    <div class="form-check form-switch mb-3">
                                                        <input class="form-check-input" type="checkbox" id="isActive"
                                                            name="isActive" <%=editingProduct ? (editingProduct.isActive
                                                            ? 'checked' : '' ) : 'checked' %>>
                                                        <label class="form-check-label" for="isActive">Hiển thị sản
                                                            phẩm</label>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Ảnh thumbnail</label>
                                                        <input type="file" name="thumbnail" class="form-control"
                                                            accept="image/*">
                                                        <% if (editingProduct && editingProduct.thumbnailUrl) { %>
                                                            <img src="<%= editingProduct.thumbnailUrl %>"
                                                                alt="<%= editingProduct.name %>"
                                                                class="img-fluid rounded mt-2"
                                                                style="max-height: 140px;">
                                                            <% } %>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Bộ sưu tập demo (3 ảnh)</label>
                                                        <input type="file" name="galleryImages" class="form-control"
                                                            accept="image/*" multiple>
                                                        <small class="text-muted d-block mt-1">Vui lòng chọn đủ 3 ảnh để
                                                            hiển thị
                                                            ở trang chi tiết.</small>
                                                        <% if (editingProduct && editingProduct.galleries &&
                                                            editingProduct.galleries.length) { %>
                                                            <div class="d-flex flex-wrap gap-2 mt-2">
                                                                <% editingProduct.galleries.forEach(function(gallery){
                                                                    %>
                                                                    <img src="<%= gallery.imageUrl %>" alt="gallery"
                                                                        class="rounded"
                                                                        style="width: 90px; height: 90px; object-fit: cover;">
                                                                    <% }) %>
                                                            </div>
                                                            <% } %>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Ảnh theo màu sắc</label>
                                                        <div id="color-image-list" class="d-flex flex-column gap-3">
                                                            <div
                                                                class="color-image-row d-flex gap-3 align-items-center">
                                                                <select name="colorImageColorIds[]" class="form-select">
                                                                    <option value="">Chọn màu</option>
                                                                    <% colorOptions.forEach(function(color){ %>
                                                                        <option value="<%= color.id %>">
                                                                            <%= color.value %>
                                                                        </option>
                                                                        <% }) %>
                                                                </select>
                                                                <input type="file" name="colorImageFiles[]"
                                                                    class="form-control" accept="image/*">
                                                                <button type="button"
                                                                    class="btn btn-outline-danger remove-color-image">&times;</button>
                                                            </div>
                                                        </div>
                                                        <button type="button"
                                                            class="btn btn-outline-secondary btn-sm mt-2"
                                                            id="addColorImageRow">+ Thêm màu</button>
                                                        <% if (editingProduct && editingProduct.colorImages &&
                                                            editingProduct.colorImages.length) { %>
                                                            <div class="d-flex flex-wrap gap-3 mt-3">
                                                                <% editingProduct.colorImages.forEach(function(img){ %>
                                                                    <div class="border rounded p-2 text-center"
                                                                        style="width: 120px;">
                                                                        <small class="d-block text-muted mb-1">#<%=
                                                                                img.colorValueId %></small>
                                                                        <img src="<%= img.imageUrl %>" alt="color-image"
                                                                            class="img-fluid rounded"
                                                                            style="height: 80px; object-fit: cover;">
                                                                    </div>
                                                                    <% }) %>
                                                            </div>
                                                            <% } %>
                                                    </div>
                                                    <div class="mb-4">
                                                        <label class="form-label">Ma trận biến thể (Giá &amp; tồn
                                                            kho)</label>
                                                        <div class="table-responsive border rounded">
                                                            <table
                                                                class="table table-bordered align-middle text-center mb-0">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th style="min-width: 160px;">Màu / Size</th>
                                                                        <% sizeOptions.forEach(function(size){ %>
                                                                            <th>
                                                                                <%= size.value %>
                                                                            </th>
                                                                            <% }) %>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <% colorOptions.forEach(function(color){ %>
                                                                        <tr>
                                                                            <th class="text-start">
                                                                                <span class="badge bg-light text-dark">
                                                                                    <%= color.value %>
                                                                                </span>
                                                                            </th>
                                                                            <% sizeOptions.forEach(function(size){ const
                                                                                snapshot=inventorySnapshot &&
                                                                                inventorySnapshot[String(color.id)] &&
                                                                                inventorySnapshot[String(color.id)][String(size.id)]
                                                                                ?
                                                                                inventorySnapshot[String(color.id)][String(size.id)]
                                                                                : null; %>
                                                                                <td>
                                                                                    <input type="number" step="1000"
                                                                                        class="form-control form-control-sm mb-2"
                                                                                        placeholder="Giá"
                                                                                        name="inventory[<%= color.id %>][<%= size.id %>][price]"
                                                                                        value="<%= snapshot ? snapshot.price : '' %>">
                                                                                    <input type="number" min="0"
                                                                                        class="form-control form-control-sm"
                                                                                        placeholder="Tồn kho"
                                                                                        name="inventory[<%= color.id %>][<%= size.id %>][stock]"
                                                                                        value="<%= snapshot ? snapshot.stock : '' %>">
                                                                                </td>
                                                                                <% }) %>
                                                                        </tr>
                                                                        <% }) %>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                        <small class="text-muted d-block mt-2">
                                                            Nếu bỏ trống giá, hệ thống sẽ dùng giá cơ bản của sản phẩm.
                                                        </small>
                                                    </div>
                                                    <div class="d-flex gap-2">
                                                        <button type="submit" class="btn btn-dark flex-grow-1">
                                                            <%= editingProduct ? "Cập nhật" : "Tạo mới" %>
                                                        </button>
                                                        <% if (editingProduct) { %>
                                                            <a href="/admin/products"
                                                                class="btn btn-outline-secondary">Huỷ</a>
                                                            <% } %>
                                                    </div>
                                                </form>
                                                <% if (editingProduct) { %>
                                                    <div class="mt-4">
                                                        <div class="card shadow-sm">
                                                            <div class="card-body">
                                                                <div
                                                                    class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                                                                    <div>
                                                                        <h5 class="card-title mb-1">Inventory Matrix
                                                                        </h5>
                                                                        <small class="text-muted">Quản lý tồn kho theo
                                                                            màu &amp;
                                                                            size</small>
                                                                    </div>
                                                                </div>
                                                                <div id="inventory-matrix-root"
                                                                    data-product-id="<%= editingProduct.id %>">
                                                                    <div class="text-muted text-center py-4">Đang chuẩn
                                                                        bị
                                                                        dữ liệu...</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-7">
                                        <div class="card shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">Danh sách sản phẩm</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-borderless align-middle"
                                                        style="min-width: 640px;">
                                                        <thead>
                                                            <tr class="text-uppercase small text-muted">
                                                                <th style="width: 4rem;">ID</th>
                                                                <th style="min-width: 220px;">Sản phẩm</th>
                                                                <th style="width: 120px;" class="text-end">Giá</th>
                                                                <th>Danh mục</th>
                                                                <th style="width: 120px;">Trạng thái</th>
                                                                <th style="width: 130px;" class="text-end">Thao tác</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% if (products && products.length) { %>
                                                                <% products.forEach(function(product){ %>
                                                                    <tr class="border-bottom"
                                                                        style="background: #f8f8f8;">
                                                                        <td class="fw-semibold">
                                                                            <%= product.id %>
                                                                        </td>
                                                                        <td>
                                                                            <div
                                                                                class="d-flex align-items-center gap-3">
                                                                                <div class="rounded-3 overflow-hidden"
                                                                                    style="width: 64px; height: 64px; background: #fff;">
                                                                                    <% if (product.thumbnailUrl) { %>
                                                                                        <img src="<%= product.thumbnailUrl %>"
                                                                                            alt="<%= product.name %>"
                                                                                            style="width: 100%; height: 100%; object-fit: cover;">
                                                                                        <% } else { %>
                                                                                            <div class="w-100 h-100 d-flex align-items-center justify-content-center text-muted small"
                                                                                                style="background: #f0f0f0;">
                                                                                                N/A</div>
                                                                                            <% } %>
                                                                                </div>
                                                                                <div>
                                                                                    <div class="fw-semibold fs-5 mb-1">
                                                                                        <%= product.name %>
                                                                                    </div>
                                                                                    <small class="text-muted">Slug:
                                                                                        <%= product.slug %>
                                                                                    </small>
                                                                                </div>
                                                                            </div>
                                                                        </td>
                                                                        <td class="text-end fw-semibold">
                                                                            <%= Number(product.basePrice ||
                                                                                0).toLocaleString('vi-VN', {
                                                                                style: 'currency' , currency: 'VND' })
                                                                                %>
                                                                        </td>
                                                                        <td>
                                                                            <% if (product.Categories &&
                                                                                product.Categories.length) { %>
                                                                                <div class="d-flex flex-wrap gap-1">
                                                                                    <% product.Categories.forEach(function(category){
                                                                                        %>
                                                                                        <span
                                                                                            class="badge bg-light text-muted fw-normal">
                                                                                            <%= category.name %>
                                                                                        </span>
                                                                                        <% }) %>
                                                                                </div>
                                                                                <% } else { %>
                                                                                    <span class="text-muted">Chưa
                                                                                        gán</span>
                                                                                    <% } %>
                                                                        </td>
                                                                        <td>
                                                                            <% if (product.isActive) { %>
                                                                                <span
                                                                                    class="badge rounded-pill bg-success-subtle text-success px-3 py-2">Active</span>
                                                                                <% } else { %>
                                                                                    <span
                                                                                        class="badge rounded-pill bg-secondary px-3 py-2">Ẩn</span>
                                                                                    <% } %>
                                                                        </td>
                                                                        <td class="text-end">
                                                                            <a class="btn btn-outline-dark btn-sm me-2"
                                                                                href="/admin/products/<%= product.id %>/edit">Edit</a>
                                                                            <form class="d-inline-block" method="POST"
                                                                                action="/admin/products/<%= product.id %>/delete"
                                                                                onsubmit="return confirm('Xoá sản phẩm này?');">
                                                                                <button
                                                                                    class="btn btn-outline-danger btn-sm"
                                                                                    type="submit">Delete</button>
                                                                            </form>
                                                                        </td>
                                                                    </tr>
                                                                    <% }) %>
                                                                        <% } else { %>
                                                                            <tr>
                                                                                <td colspan="6"
                                                                                    class="text-center text-muted py-4">
                                                                                    Chưa có sản phẩm
                                                                                    nào.</td>
                                                                            </tr>
                                                                            <% } %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
        </main>
        <%- include('../partials/footer') %>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
            <script>
                (function () {
                    const list = document.getElementById("color-image-list");
                    const addBtn = document.getElementById("addColorImageRow");
                    if (!list || !addBtn) return;
                    const ensureSelectName = (row) => {
                        const select = row.querySelector("select");
                        const fileInput = row.querySelector('input[type="file"]');
                        if (!select || !fileInput) return;
                        if (!select.dataset.originalName) {
                            select.dataset.originalName = select.name || "colorImageColorIds[]";
                        }
                        if (fileInput.files && fileInput.files.length > 0) {
                            select.name = select.dataset.originalName;
                        } else {
                            select.name = "";
                        }
                    };
                    const bindRowEvents = (row) => {
                        const fileInput = row.querySelector('input[type="file"]');
                        if (fileInput) {
                            fileInput.addEventListener("change", () => ensureSelectName(row));
                            ensureSelectName(row);
                        }
                        const removeBtn = row.querySelector(".remove-color-image");
                        if (removeBtn) {
                            removeBtn.addEventListener("click", () => {
                                if (list.children.length > 1) {
                                    row.remove();
                                } else {
                                    row.querySelectorAll("input").forEach((input) => (input.value = ""));
                                    const select = row.querySelector("select");
                                    if (select) select.selectedIndex = 0;
                                }
                            });
                        }
                    };
                    Array.from(list.children).forEach((row) => bindRowEvents(row));
                    addBtn.addEventListener("click", () => {
                        const template = list.children[0];
                        if (!template) return;
                        const clone = template.cloneNode(true);
                        clone.querySelectorAll("input").forEach((input) => (input.value = ""));
                        const select = clone.querySelector("select");
                        if (select) select.selectedIndex = 0;
                        list.appendChild(clone);
                        bindRowEvents(clone);
                    });
                })();
            </script>
            <% if (editingProduct) { %>
                <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
                <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
                <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
                <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
                <script type="text/babel" data-presets="env,react" src="/js/AdminStockMatrix.jsx"></script>
                <% } %>
</body>

</html>