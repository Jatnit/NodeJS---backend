<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moda Studio | Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .checkout-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 992px) {
            .checkout-layout {
                grid-template-columns: 3fr 2fr;
            }

            .summary-column {
                position: sticky;
                top: 100px;
                height: fit-content;
            }
        }

        .floating-label label {
            font-size: 0.85rem;
            color: var(--muted-text);
        }

        .floating-label input,
        .floating-label textarea {
            border-radius: 12px;
            border: 1px solid var(--border-color, #ccc);
        }

        .payment-card {
            border: 1px solid var(--border-color, #ccc);
            border-radius: 16px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-card.selected {
            border-color: #111;
            background-color: #111;
            color: #fff;
        }

        .summary-card {
            border-radius: 20px;
            border: 1px solid var(--border-color, #ddd);
            padding: 1.5rem;
            background: var(--card-bg, #fff);
            box-shadow: 0 25px 40px rgba(0, 0, 0, 0.08);
        }
    </style>
</head>

<body class="<%= theme === 'dark' ? 'theme-dark' : 'theme-light' %>">
    <%- include('partials/header') %>

        <main class="site-main">
            <div class="container py-5">
                <% if (errorMessage) { %>
                    <div class="alert alert-danger text-center">
                        <%= errorMessage %>
                    </div>
                <% } %>

                <% if (!cart || !cart.items || !cart.items.length) { %>
                    <p class="text-center text-muted">Giỏ hàng trống. <a href="/products">Tiếp tục mua sắm</a></p>
                <% } else { %>
                    <form action="/checkout" method="POST" class="checkout-layout" id="checkoutForm">
                        <section>
                            <h3 class="mb-4 text-uppercase" style="letter-spacing: 0.2em;">Thông tin giao hàng</h3>

                            <% if (addresses && addresses.length > 0) { %>
                                <div class="mb-4">
                                    <label class="form-label text-muted">Chọn địa chỉ đã lưu</label>
                                    <div class="list-group">
                                        <% addresses.forEach(function(address){ %>
                                            <label class="list-group-item list-group-item-action">
                                                <input type="radio" name="addressId" value="<%= address.id %>"
                                                    class="form-check-input me-2"
                                                    data-name="<%= address.recipientName || '' %>"
                                                    data-phone="<%= address.phoneNumber || '' %>"
                                                    data-address="<%= [address.addressLine, address.ward, address.district, address.city].filter(Boolean).join(', ') %>"
                                                    <%= address.isDefault ? "checked" : "" %>>
                                                <div>
                                                    <strong><%= address.recipientName %></strong>
                                                    <p class="mb-0"><%= address.phoneNumber %></p>
                                                    <p class="mb-0"><%= [address.addressLine, address.ward, address.district, address.city].filter(Boolean).join(', ') %></p>
                                                </div>
                                            </label>
                                        <% }) %>
                                    </div>
                                </div>
                            <% } %>

                            <div class="row g-3 mb-3 floating-label">
                                <div class="col-md-6">
                                    <label for="shippingName" class="form-label">Tên người nhận</label>
                                    <input type="text" class="form-control" id="shippingName" name="shippingName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="shippingPhone" class="form-label">Số điện thoại</label>
                                    <input type="text" class="form-control" id="shippingPhone" name="shippingPhone"
                                        required>
                                </div>
                            </div>
                            <div class="floating-label mb-3">
                                <label for="shippingAddress" class="form-label">Địa chỉ giao hàng</label>
                                <textarea class="form-control" id="shippingAddress" name="shippingAddress" rows="3"
                                    required></textarea>
                            </div>
                            <div class="floating-label mb-4">
                                <label for="note" class="form-label">Ghi chú (tuỳ chọn)</label>
                                <textarea class="form-control" id="note" name="note" rows="2"></textarea>
                            </div>

                            <h3 class="mb-3 text-uppercase" style="letter-spacing: 0.2em;">Phương thức thanh toán</h3>
                            <div class="d-flex flex-column flex-md-row gap-3">
                                <label class="payment-card flex-fill" data-payment="COD">
                                    <input type="radio" name="paymentMethod" value="COD" class="form-check-input me-2"
                                        checked hidden>
                                    <strong>COD</strong>
                                    <p class="mb-0 text-muted">Thanh toán khi nhận hàng</p>
                                </label>
                                <label class="payment-card flex-fill" data-payment="Banking">
                                    <input type="radio" name="paymentMethod" value="Banking"
                                        class="form-check-input me-2" hidden>
                                    <strong>Banking</strong>
                                    <p class="mb-0 text-muted">Chuyển khoản ngân hàng</p>
                                </label>
                            </div>
                        </section>

                        <aside class="summary-column">
                            <div class="summary-card">
                                <h5 class="text-uppercase mb-3" style="letter-spacing: 0.2em;">Tổng quan đơn hàng</h5>
                                <div class="mb-3">
                                    <% cart.items.forEach(function(item){ %>
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <p class="mb-0 fw-semibold"><%= item.name %></p>
                                                <% if (item.variantLabel) { %>
                                                    <small class="text-muted">
                                                        <%= item.variantLabel %>
                                                    </small>
                                                <% } %>
                                            </div>
                                            <p class="mb-0">
                                                <%= item.quantity %> x <%= item.price.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %>
                                            </p>
                                        </div>
                                    <% }) %>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <span class="text-muted">Tạm tính</span>
                                    <strong>
                                        <%= cart.subtotal.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %>
                                    </strong>
                                </div>
                                <button class="btn btn-dark w-100 py-3 text-uppercase" style="letter-spacing: 0.2em;">
                                    Đặt hàng
                                </button>
                            </div>
                        </aside>
                    </form>
                <% } %>
            </div>
        </main>

        <%- include('partials/footer') %>

            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    const addressRadios = document.querySelectorAll('input[name="addressId"]');
                    const nameInput = document.getElementById("shippingName");
                    const phoneInput = document.getElementById("shippingPhone");
                    const addressInput = document.getElementById("shippingAddress");
                    const paymentCards = document.querySelectorAll(".payment-card");

                    addressRadios.forEach((radio) => {
                        radio.addEventListener("change", () => {
                            nameInput.value = radio.dataset.name || "";
                            phoneInput.value = radio.dataset.phone || "";
                            addressInput.value = radio.dataset.address || "";
                        });
                        if (radio.checked) radio.dispatchEvent(new Event("change"));
                    });

                    paymentCards.forEach((card) => {
                        card.addEventListener("click", () => {
                            paymentCards.forEach((c) => c.classList.remove("selected"));
                            card.classList.add("selected");
                            const input = card.querySelector('input[name="paymentMethod"]');
                            if (input) input.checked = true;
                        });
                        if (card.querySelector('input[name="paymentMethod"]').checked) {
                            card.classList.add("selected");
                        }
                    });
                });
            </script>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>

