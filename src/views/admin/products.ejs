<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moda Studio | Quản lý sản phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
</head>

<body class="<%= theme === 'dark' ? 'theme-dark' : 'theme-light' %>">
    <%- include('../partials/header') %>
        <main class="site-main py-5">
            <div class="container pt-5 ">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <p class="text-muted text-uppercase mb-1" style="letter-spacing: 0.3em;">Admin</p>
                        <h2 class="fw-bold">Quản lý sản phẩm</h2>
                    </div>
                    <div class="btn-group">
                        <a class="btn btn-outline-dark" href="/admin/users">Users</a>
                        <a class="btn btn-outline-dark" href="/admin/categories">Categories</a>
                        <a class="btn btn-dark" href="/admin/products">Products</a>
                    </div>
                </div>

                <% if (successMessage) { %>
                    <div class="alert alert-success">
                        <%= successMessage %>
                    </div>
                    <% } %>
                        <% if (errorMessage) { %>
                            <div class="alert alert-danger">
                                <%= errorMessage %>
                            </div>
                            <% } %>

                                <div class="row">
                                    <div class="col-lg-5 mb-4">
                                        <div class="card shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                                    <%= editingProduct ? "Chỉnh sửa sản phẩm" : "Tạo sản phẩm mới" %>
                                                </h5>
                                                <form
                                                    action="<%= editingProduct ? `/admin/products/${editingProduct.id}` : '/admin/products' %>"
                                                    method="POST" enctype="multipart/form-data">
                                                    <div class="mb-3">
                                                        <label class="form-label">Tên sản phẩm</label>
                                                        <input type="text" name="name" class="form-control"
                                                            value="<%= editingProduct ? editingProduct.name : (formData && formData.name) || '' %>"
                                                            required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Slug</label>
                                                        <input type="text" name="slug" class="form-control"
                                                            placeholder="để trống để tự tạo"
                                                            value="<%= editingProduct ? editingProduct.slug : (formData && formData.slug) || '' %>">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Giá (VND)</label>
                                                        <input type="number" name="basePrice" min="0"
                                                            class="form-control"
                                                            value="<%= editingProduct ? editingProduct.basePrice : (formData && formData.basePrice) || '' %>"
                                                            required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Mô tả</label>
                                                        <textarea name="description" rows="3"
                                                            class="form-control"><%= editingProduct ? editingProduct.description || '' : (formData && formData.description) || '' %></textarea>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Danh mục</label>
                                                        <select name="categoryIds" class="form-select" multiple
                                                            size="6">
                                                            <% const selectedCats=editingProduct ?
                                                                editingProduct.categoryIds : (formData &&
                                                                formData.categoryIds); %>
                                                                <% categories.forEach(function(category){ %>
                                                                    <option value="<%= category.id %>" <%=selectedCats
                                                                        && selectedCats.includes(String(category.id))
                                                                        ? 'selected' : '' %>>
                                                                        <%= category.name %>
                                                                    </option>
                                                                    <% }) %>
                                                        </select>
                                                        <small class="text-muted">Giữ Ctrl / Cmd để chọn nhiều danh
                                                            mục.</small>
                                                    </div>
                                                    <div class="form-check form-switch mb-3">
                                                        <input class="form-check-input" type="checkbox" id="isActive"
                                                            name="isActive" <%=editingProduct ? (editingProduct.isActive
                                                            ? 'checked' : '' ) : 'checked' %>>
                                                        <label class="form-check-label" for="isActive">Hiển thị sản
                                                            phẩm</label>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Ảnh thumbnail</label>
                                                        <input type="file" name="thumbnail" class="form-control"
                                                            accept="image/*">
                                                        <% if (editingProduct && editingProduct.thumbnailUrl) { %>
                                                            <img src="<%= editingProduct.thumbnailUrl %>"
                                                                alt="<%= editingProduct.name %>"
                                                                class="img-fluid rounded mt-2"
                                                                style="max-height: 140px;">
                                                            <% } %>
                                                    </div>
                                                    <div class="d-flex gap-2">
                                                        <button type="submit" class="btn btn-dark flex-grow-1">
                                                            <%= editingProduct ? "Cập nhật" : "Tạo mới" %>
                                                        </button>
                                                        <% if (editingProduct) { %>
                                                            <a href="/admin/products"
                                                                class="btn btn-outline-secondary">Huỷ</a>
                                                            <% } %>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-7">
                                        <div class="card shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">Danh sách sản phẩm</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-hover align-middle">
                                                        <thead>
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Sản phẩm</th>
                                                                <th>Giá</th>
                                                                <th>Danh mục</th>
                                                                <th>Trạng thái</th>
                                                                <th></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% if (products && products.length) { %>
                                                                <% products.forEach(function(product){ %>
                                                                    <tr>
                                                                        <td>
                                                                            <%= product.id %>
                                                                        </td>
                                                                        <td class="d-flex align-items-center gap-2">
                                                                            <% if (product.thumbnailUrl) { %>
                                                                                <img src="<%= product.thumbnailUrl %>"
                                                                                    alt="<%= product.name %>"
                                                                                    class="rounded"
                                                                                    style="height: 48px; width: 48px; object-fit: cover;">
                                                                                <% } %>
                                                                                    <div>
                                                                                        <div class="fw-semibold">
                                                                                            <%= product.name %>
                                                                                        </div>
                                                                                        <small class="text-muted">
                                                                                            <%= product.slug %>
                                                                                        </small>
                                                                                    </div>
                                                                        </td>
                                                                        <td>
                                                                            <%= Number(product.basePrice ||
                                                                                0).toLocaleString('vi-VN', {
                                                                                style: 'currency' , currency: 'VND' })
                                                                                %>
                                                                        </td>
                                                                        <td>
                                                                            <% if (product.Categories &&
                                                                                product.Categories.length) { %>
                                                                                <small class="text-muted">
                                                                                    <%= product.Categories.map((cat)=>
                                                                                        cat.name).join(", ") %>
                                                                                </small>
                                                                                <% } else { %>
                                                                                    <span class="text-muted">Chưa
                                                                                        gán</span>
                                                                                    <% } %>
                                                                        </td>
                                                                        <td>
                                                                            <% if (product.isActive) { %>
                                                                                <span
                                                                                    class="badge bg-success-subtle text-success">Active</span>
                                                                                <% } else { %>
                                                                                    <span
                                                                                        class="badge bg-secondary">Ẩn</span>
                                                                                    <% } %>
                                                                        </td>
                                                                        <td class="text-end">
                                                                            <a class="btn btn-sm btn-outline-dark"
                                                                                href="/admin/products/<%= product.id %>/edit">Edit</a>
                                                                            <form class="d-inline-block" method="POST"
                                                                                action="/admin/products/<%= product.id %>/delete"
                                                                                onsubmit="return confirm('Xoá sản phẩm này?');">
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    type="submit">Delete</button>
                                                                            </form>
                                                                        </td>
                                                                    </tr>
                                                                    <% }) %>
                                                                        <% } else { %>
                                                                            <tr>
                                                                                <td colspan="6"
                                                                                    class="text-center text-muted">Chưa
                                                                                    có sản phẩm nào.</td>
                                                                            </tr>
                                                                            <% } %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
            </div>
        </main>
        <%- include('../partials/footer') %>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>